dist: trusty
sudo: required
language: generic
services:
- docker
addons:
  sonarcloud:
    organization: "3r1co-github"
env:
  - DOCKER_IMAGE_NAME="3r1co/registry-ui:$TRAVIS_BUILD_NUMBER"
cache:
  - pip
  - npm
before_install:
  - cd /tmp
  - curl https://binaries.sonarsource.com/Distribution/sonar-scanner-cli/sonar-scanner-cli-3.3.0.1492-linux.zip --output sonar-scanner.zip
  - unzip sonar-scanner.zip
  - mv sonar-scanner-3.3.0.1492-linux /opt/
  - export PATH=$PATH:/opt/sonar-scanner-3.3.0.1492-linux/bin
  - pyenv global 3.6.3
  - nvm install node
  - pip install -r requirements.txt
  - pip install -r test_requirements.txt
  - cd frontend
  - npm install
  - cd .. #Important to go back to root before installation step
install:
  - pytest --cov=. tests/
  - coverage xml -i
  - cd frontend
  - npm test -- --coverage
  - sonar-scanner -Dsonar.projectKey=3r1co_registry-frontend -Dsonar.sources=. -Dsonar.python.coverage.reportPath=coverage.xml -Dsonar.javascript.lcov.reportPaths=frontend/coverage/lcov.info
before_script:
  - docker login -u="$DOCKER_USERNAME" -p="$DOCKER_PASSWORD"
  - docker build -t $DOCKER_IMAGE_NAME .
  - docker push $DOCKER_IMAGE_NAME